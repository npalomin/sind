---
title: "leaflet-webapp"
output: 
  html_document:
    code_folding: hide
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r message=FALSE, warning=FALSE}
library(sf)
library(readr)
library(mapview)
library(tidyverse)
library(ggthemes)
library(webshot)
library(leaflet)
library(leafgl)
library(leaflet.extras)
library(htmlwidgets)
library(RColorBrewer)
library(here)
#install.packages("skimr")
#install.packages("pillar")
#install.packages("dplyr")
library(pillar)
library(skimr)
library(janitor)
library(unikn)
library(tmap)
```

```{r}
geom <- st_read(here("2022/data/geoms.gpkg"))
```

```{r}
geom %>%
  filter(!is.na(Sector)) %>%
  filter(!is.na(Manufacturing.making)) -> geom1
```

```{r}
skim(geom1)
```


# Interactive map
```{r}
url_map <- "https://api.mapbox.com/styles/v1/npalomin/ckkfbcl5622tv17rzxz1lpt33/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoibnBhbG9taW4iLCJhIjoiY2owMDF5YXQxMDA2eDMybmwwd2tqYTU3bSJ9.Icvrku6Q57o8L0gncJI89g"

# sector
colorRampPalette(brewer.pal(8, "Set1"))(10) -> pal10
seecol(pal10)

paletteS <- colorFactor(palette = pal10, levels = unique(geom1$Sector))

paletteM <- colorFactor(palette = rev(colorRampPalette(brewer.pal(9, "Set1"))(2)),
                        levels = unique(geom1$Manufacturing.making), na.color = "transparent")



seecol(paletteM(unique(geom1$Manufacturing.making)))
```

ref: https://rstudio.github.io/leaflet/colors.html
ref: file:///Users/nicolas/Documents/R_GitHub/BGS/2bu_2ye.html
ref: https://github.com/npalomin/BGS/blob/main/Data_preparation.Rmd
ref: file:///Users/nicolas/Documents/R_GitHub/urbandp/shiny_test/Exploratory.html

```{r}
sf_use_s2(FALSE)

geom1 %>%
  st_transform(4326) %>%
  leaflet() %>%
  addTiles(urlTemplate = url_map, group = "Map") %>%
  addProviderTiles(providers$CartoDB.Positron, group = "Light") %>%
  # sector
  addPolygons(color = ~paletteS(Sector),
              fillColor = ~paletteS(Sector),
              stroke = TRUE,
              weight = 1,
              opacity = 1,
              fillOpacity = 0.8,
              label = paste(
                "Name: ", geom1$Name.of.organis, "<br/>",
                "Sector: ", geom1$Sector, "<br/>",
                "Category: ", geom1$Category.plus, "<br/>",
                "Premises type: ", geom1$Premises, "<br/>",
                "Address: ", paste0(geom1$Street.name.eg, " ", geom1$Street.number), "<br/>",
                "<img src='", geom$External.photo, "' width=\"300\">",
                sep="") %>% lapply(htmltools::HTML),
              group = "Sector",
              highlightOptions = highlightOptions(fillOpacity = 0.75, weight = 1, opacity = 1, color = "yellow", bringToFront = TRUE, sendToBack = TRUE)) %>%
  addLegend(colors = pal10, labels = unique(geom1$Sector), group = "Sector", title = "Sector", opacity = 1) %>%
  addPolygons(color = ~paletteM(Manufacturing.making),
              fillColor = ~paletteM(Manufacturing.making),
              stroke = TRUE,
              weight = 1,
              opacity = 1,
              fillOpacity = 0.8,
              group = "Making",
              label = paste(
                "Name: ", geom1$Name.of.organis, "<br/>",
                "Sector: ", geom1$Sector, "<br/>",
                "Category: ", geom1$Category.plus, "<br/>",
                "Manufacturing/Making: ", geom1$Manufacturing.making,
                sep="") %>% lapply(htmltools::HTML),
              highlightOptions = highlightOptions(fillOpacity = 0.75, weight = 1, opacity = 1, color = "yellow", bringToFront = TRUE, sendToBack = TRUE)) %>%
  addLegend(colors = rev(colorRampPalette(brewer.pal(9, "Set1"))(2)),
            labels = unique(geom1$Manufacturing.making), group = "Making", opacity = 1,
            title = "Manufacturing/Making") %>%
  # layers controls
  addLayersControl(
    baseGroups = c("Map","Light"),
    overlayGroups = c("Sector", "Making"),
    options = layersControlOptions(collapsed = FALSE),
    position = "topleft") %>%
  hideGroup(c("Making"))
```

```{r}
geom1 %>%
  st_drop_geometry() %>%
  count(Manufacturing.making)
```


